-- PARAMETRO DE PERÍODO MENSUAL
DECLARE FILTRO_PERIODO DATE DEFAULT /*'YYYY-MM-01'*/ <FILTRO_PERIODO>
;

-- PARAMETRO DE SITES A INSERTAR
DECLARE VAR_SITES ARRAY <STRING>;
SET VAR_SITES = ['MCO','MLA','MLB','MLC','MLM','MLU','MLV']
;

-- -- BORRO REGISTROS PARA EVITAR DUPLICIDAD AL INSERTAR MISMO PERIODO VARIAS VECES
DELETE `meli-bi-data.SBOX_MKTVIS.DASH_REAL_ESTATE_LIVE_LISTINGS_MONTHLY`
WHERE YEAR_MONTH = FILTRO_PERIODO
;


INSERT INTO `meli-bi-data.SBOX_MKTVIS.DASH_REAL_ESTATE_LIVE_LISTINGS_MONTHLY`

WITH ATRIBUTOS AS
(
  SELECT
      SIT_SITE_ID
    , USER_TYPE
    , CUS_CUST_ID
    , NOMBREDELCUS
    , ITE_ITEM_ID
    , ITE_ITEM_TITLE
    , SUB_VERTICAL
    , TIER
    , ESTADO
    , CIUDAD
    -- , DIRECCION COMENTADO PORQUE ESTA FLAGEADO POR PII
    , BARRIO_COMUNA
    , LATITUD
    , LONGITUD
    , VIDEO
    , CATEGORIA_L1
    , CATEGORIA_L2
    , CATEGORIA_L3
    , CATEGORIA_L4
    , CATEGORIA_L5
    , CATEGORIA_L6
    , CATEGORIA_L7
    , COMBO
    , ITEM_PADRE
    , ITE_ITEM_DOM_DOMAIN_ID
    , CONDICION
    , ITE_LISTING_TYPE_DESC
    , OPERATION

    -- TOTAL AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_TOTAL_AREA
    , (CASE WHEN REGEXP_EXTRACT(TOTAL_AREA,'[0-9]+') = '0' THEN NULL -- si es 0 ponelo null para que no afecte a promedios tirandolo para abajo
            ELSE REGEXP_EXTRACT(LEFT(TOTAL_AREA,10),'[0-9]+') END) AS TOTAL_AREA -- si no el valor original

    -- COVERED AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_COVERED_AREA
    , (CASE WHEN REGEXP_EXTRACT(COVERED_AREA,'[0-9]+') = '0' THEN NULL -- si es 0 ponelo null para que no afecte a promedios tirandolo para abajo
            ELSE REGEXP_EXTRACT(LEFT(COVERED_AREA,10),'[0-9]+') END) AS COVERED_AREA -- si no el valor original

    -- BALCONY AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_BALCONY_AREA
    , REGEXP_EXTRACT(LEFT(BALCONY_AREA,10),'[0-9]+') AS BALCONY_AREA -- 10 m²


    , REGEXP_EXTRACT(LEFT(PROPERTY_AGE,10),'[0-9]+') AS PROPERTY_AGE -- SIEMPRE ES AÑOS

    , PROPERTY_TYPE

    , REGEXP_EXTRACT(LEFT(BEDROOMS,10),'[0-9]+') AS BEDROOMS
    , REGEXP_EXTRACT(LEFT(FULL_BATHROOMS,10),'[0-9]+') AS FULL_BATHROOMS 
    , REGEXP_EXTRACT(LEFT(ROOMS,10),'[0-9]+') AS ROOMS

    , REGEXP_EXTRACT(UPPER(MAINTENANCE_FEE),'[A-Z]+') AS SIT_CURRENCY_MAINTENANCE_FEE
    , CAST(LEFT(REGEXP_EXTRACT(MAINTENANCE_FEE,'[0-9]+'),10) AS NUMERIC) AS MAINTENANCE_FEE



    , APARTMENT_PROPERTY_SUBTYPE

    , CAST(LEFT(PARKING_LOTS,10) AS NUMERIC) AS PARKING_LOTS

    -- ATRIBUTOS DE DESARROLLO
    , REGEXP_EXTRACT(UPPER(RESERVATION_FEE),'[A-Z]+') AS SIT_CURRENCY_RESERVATION_FEE
    , CAST(LEFT(REGEXP_EXTRACT(RESERVATION_FEE,'[0-9]+'),10) AS NUMERIC) AS RESERVATION_FEE
    , DEVELOPMENT_NAME
    , DEVELOPMENT_STATUS
    , POSSESSION_STATUS
    , CMG_SITE
    , PROPERTY_CODE
    , CONSTRUCTS
    , POSSESSION_DATE
    , DOWN_PAYMENT

    -- ATRIBUTOS BOOLEANOS: Sí/No
    , FURNISHED
    , HAS_BUSINESS_CENTER
    , HAS_GYM
    , HAS_LAUNDRY
    , HAS_COMMON_LAUNDRY
    , HAS_HEATING
    , HAS_MULTIPURPOSE_ROOM
    , HAS_TENNIS_COURT
    , HAS_AIR_CONDITIONING
    , HAS_FRONT_DESK
    , HAS_GUEST_PARKING
    , HAS_JACUZZI
    , HAS_PLAYGROUND
    , HAS_INDOOR_FIREPLACE
    , HAS_PARTY_ROOM
    , HAS_SECURITY
    , HAS_SWIMMING_POOL
    , HAS_BARBECUE_AREA
    , HAS_GRILL
    , WITH_VIRTUAL_TOUR
    , HAS_BALCONY
    , HAS_GARDEN
    , HAS_TERRACE
    , IS_SUITABLE_FOR_PETS
    , PETS_ALLOWED
    , HAS_INTERNET_ACCESS
    , ES_FINANCIABLE

  FROM `meli-bi-data.SBOX_CLASSI_PLANNING.LK_ATRIBUTOS_IMRE` AS A
)

, LL_1 AS
(
  SELECT 
      DATE_TRUNC(I.TIM_DAY,MONTH) AS YEAR_MONTH
    , I.TIM_DAY
    , I.SIT_CURRENCY_ID AS SITE_CURRENCY_ID -- EN CASO QUE HAYA DUPLICADOS, REVISAR
    , I.ITE_CURRENT_PRICE AS SITE_CURRENCY_ITEM_PRICE -- EN CASO QUE HAYA DUPLICADOS, REVISAR
    , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN ITE_CURRENT_PRICE 
            WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN SAFE_MULTIPLY(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
            ELSE NULL END) AS ITEM_LOCAL_PRICE
    , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN ITE_CURRENT_PRICE 
            WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN SAFE_DIVIDE(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
            ELSE NULL END) AS ITEM_USD_PRICE
    , ATT.*

  FROM `meli-bi-data.WHOWNER.BT_LIVE_LISTINGS_CLASSIFIEDS` AS I

  LEFT JOIN ATRIBUTOS AS ATT
  ON ATT.ITE_ITEM_ID=I.ITE_ITEM_ID
  AND ATT.SIT_SITE_ID=I.SIT_SITE_ID
  AND I.CAT_CATEG_ID_L1 = '1459'

  -- LE AGREGO TASA DE CAMBIO PARA COLUMNAS DE PRECIO_LOCAL PRECIO_USD
  LEFT JOIN `meli-bi-data.WHOWNER.LK_CURRENCY_CONVERTION` AS TC
  ON I.SIT_SITE_ID = TC.SIT_SITE_ID
    AND I.TIM_DAY	= TC.TIM_DAY_TC


  WHERE DATE_TRUNC(I.TIM_DAY,MONTH) = FILTRO_PERIODO
  AND I.SIT_SITE_ID IN UNNEST(VAR_SITES)
  AND UPPER(I.ITE_ITEM_STATUS) IN  ('A','ACTIVE')
  AND CAT_CATEG_ID_L1 = '1459'
)

-- PARA HACER EL CALCULO EN BASE A LAS COLUMNAS CREADAS EN LL_1
SELECT DISTINCT
      YEAR_MONTH
    , SIT_SITE_ID AS SITE_ID
    , USER_TYPE
    , CAST(CUS_CUST_ID AS STRING) AS CUSTOMER_SELLER_ID
    , NOMBREDELCUS AS CUSTOMER_SELLER_NAME
    , CAST(ITE_ITEM_ID AS STRING) AS ITEM_ID
    , ITE_ITEM_TITLE AS ITEM_TITLE_NAME
    , SUB_VERTICAL
    , TIER
    , ESTADO AS ITEM_STATE 
    , CIUDAD AS ITEM_CITY
    -- , DIRECCION AS ITEM_ADDRESS COMENTADO PORQUE ESTA FLAGEADO POR PII
    , BARRIO_COMUNA AS ITEM_NEIGHBORHOOD
    , CAST(LATITUD AS STRING) AS ITEM_LATITUD
    , CAST(LONGITUD AS STRING) AS ITEM_LONGITUD
    , VIDEO AS HAS_VIDEO
    , CATEGORIA_L1 AS CATEGORY_NAME_L1
    , CATEGORIA_L2 AS CATEGORY_NAME_L2
    , CATEGORIA_L3 AS CATEGORY_NAME_L3
    , CATEGORIA_L4 AS CATEGORY_NAME_L4
    , CATEGORIA_L5 AS CATEGORY_NAME_L5
    , CATEGORIA_L6 AS CATEGORY_NAME_L6
    , CATEGORIA_L7 AS CATEGORY_NAME_L7

    , COMBO
    , CAST(ITEM_PADRE AS STRING) AS ITEM_PARENT_ID
    , ITE_ITEM_DOM_DOMAIN_ID AS ITEM_DOMAIN
    , CONDICION AS ITEM_CONDITION
    , ITE_LISTING_TYPE_DESC AS ITEM_LISTING_TYPE
    , OPERATION
    , PROPERTY_TYPE
    , MEASURE_TYPE_TOTAL_AREA
    , CAST(TOTAL_AREA AS NUMERIC) AS TOTAL_AREA
    , MEASURE_TYPE_COVERED_AREA
    , CAST(COVERED_AREA AS NUMERIC) AS COVERED_AREA
    , MEASURE_TYPE_BALCONY_AREA
    , CAST(BALCONY_AREA AS NUMERIC) AS BALCONY_AREA
    , CAST(PROPERTY_AGE AS NUMERIC) AS PROPERTY_AGE
    , CAST(BEDROOMS AS NUMERIC) AS BEDROOMS
    , CAST(FULL_BATHROOMS AS NUMERIC) AS FULL_BATHROOMS
    , CAST(ROOMS AS NUMERIC) AS ROOMS
    , SIT_CURRENCY_MAINTENANCE_FEE
    , MAINTENANCE_FEE
    , APARTMENT_PROPERTY_SUBTYPE
    , PARKING_LOTS
    , SIT_CURRENCY_RESERVATION_FEE
    , RESERVATION_FEE

    -- ATRIBUTOS DESARROLLOS
    , DEVELOPMENT_NAME
    , DEVELOPMENT_STATUS
    , POSSESSION_STATUS
    , CMG_SITE
    , PROPERTY_CODE
    , CONSTRUCTS
    , POSSESSION_DATE
    , DOWN_PAYMENT

    -- ATRIBUTOS BOOLEANOS: Sí/No
    , FURNISHED
    , HAS_BUSINESS_CENTER
    , HAS_GYM
    , HAS_LAUNDRY
    , HAS_COMMON_LAUNDRY
    , HAS_HEATING
    , HAS_MULTIPURPOSE_ROOM
    , HAS_TENNIS_COURT
    , HAS_AIR_CONDITIONING
    , HAS_FRONT_DESK
    , HAS_GUEST_PARKING
    , HAS_JACUZZI
    , HAS_PLAYGROUND
    , HAS_INDOOR_FIREPLACE
    , HAS_PARTY_ROOM
    , HAS_SECURITY
    , HAS_SWIMMING_POOL
    , HAS_BARBECUE_AREA
    , HAS_GRILL
    , WITH_VIRTUAL_TOUR
    , HAS_BALCONY
    , HAS_GARDEN
    , HAS_TERRACE
    , IS_SUITABLE_FOR_PETS
    , PETS_ALLOWED
    , HAS_INTERNET_ACCESS
    , ES_FINANCIABLE


-- COMIENZO COLUMNAS WINDOW
  , MAX(SITE_CURRENCY_ID)   OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS SITE_CURRENCY_ID -- EN CASO QUE HAYA DUPLICADOS, REVISAR
  , MAX(SITE_CURRENCY_ITEM_PRICE) OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS SITE_CURRENCY_ITEM_PRICE -- EN CASO QUE HAYA DUPLICADOS, REVISAR
  , MAX(ITEM_LOCAL_PRICE)   OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS ITEM_LOCAL_PRICE -- EN CASO QUE HAYA DUPLICADOS, REVISAR
  , MAX(ITEM_USD_PRICE) OVER (PARTITION BY YEAR_MONTH,SIT_SITE_ID,ITE_ITEM_ID ORDER BY TIM_DAY DESC) AS ITEM_USD_PRICE -- EN CASO QUE HAYA DUPLICADOS, REVISAR

-- , SUM(0) BUYER
-- , SUM(0) LLAMADAS
-- , SUM(0) WHATSAPP
-- , SUM(0) QUESTION_UNIQUE
-- , SUM(0) QUOT_UNIQUE
-- , SUM(0) RESERVAS
-- , SUM(0) OVER() AS CONTACTOS_TOTALES_UNIQ
-- , SUM(0) OVER() AS CONTACTOS_TOTALES
-- , SUM (0) OVER() AS VISITA
-- , SUM(0) OVER() AS SESIONES
-- , SUM(0) OVER() AS USERS

--COMIENZO METRICAS PARA LIVELISTING: 1. CONTEO DE ITEMS X TIM_DAY. 2. CANTIDAD DE DIAS EN EL MES EN CURSO/CERRADO
  , COUNT(ITE_ITEM_ID) OVER 
  (PARTITION BY 
      YEAR_MONTH
    , SIT_SITE_ID
    , USER_TYPE
    , CUS_CUST_ID
    , NOMBREDELCUS
    , ITE_ITEM_ID
    , ITE_ITEM_TITLE
    , SUB_VERTICAL
    , TIER
    , ESTADO
    , CIUDAD
    -- , DIRECCION COMENTADO PORQUE ESTA FLAGEADO POR PII
    , BARRIO_COMUNA
    , LATITUD
    , LONGITUD
    , VIDEO
    , CATEGORIA_L1
    , CATEGORIA_L2
    , CATEGORIA_L3
    , CATEGORIA_L4
    , CATEGORIA_L5
    , CATEGORIA_L6
    , CATEGORIA_L7
    , COMBO
    , ITEM_PADRE
    , ITE_ITEM_DOM_DOMAIN_ID
    , CONDICION
    , ITE_LISTING_TYPE_DESC
    , OPERATION
    , MEASURE_TYPE_TOTAL_AREA
    , TOTAL_AREA
    , MEASURE_TYPE_COVERED_AREA
    , COVERED_AREA
    , MEASURE_TYPE_BALCONY_AREA
    , BALCONY_AREA
    , PROPERTY_AGE
    , PROPERTY_TYPE
    , BEDROOMS
    , FULL_BATHROOMS
    , ROOMS
    , SIT_CURRENCY_MAINTENANCE_FEE
    , MAINTENANCE_FEE
    , APARTMENT_PROPERTY_SUBTYPE
    , PARKING_LOTS
    , SIT_CURRENCY_RESERVATION_FEE
    , RESERVATION_FEE
    , DEVELOPMENT_NAME
    , DEVELOPMENT_STATUS
    , POSSESSION_STATUS
    , CMG_SITE
    , PROPERTY_CODE
    , CONSTRUCTS
    , POSSESSION_DATE
    , DOWN_PAYMENT
    , FURNISHED
    , HAS_BUSINESS_CENTER
    , HAS_GYM
    , HAS_LAUNDRY
    , HAS_COMMON_LAUNDRY
    , HAS_HEATING
    , HAS_MULTIPURPOSE_ROOM
    , HAS_TENNIS_COURT
    , HAS_AIR_CONDITIONING
    , HAS_FRONT_DESK
    , HAS_GUEST_PARKING
    , HAS_JACUZZI
    , HAS_PLAYGROUND
    , HAS_INDOOR_FIREPLACE
    , HAS_PARTY_ROOM
    , HAS_SECURITY
    , HAS_SWIMMING_POOL
    , HAS_BARBECUE_AREA
    , HAS_GRILL
    , WITH_VIRTUAL_TOUR
    , HAS_BALCONY
    , HAS_GARDEN
    , HAS_TERRACE
    , IS_SUITABLE_FOR_PETS
    , PETS_ALLOWED
    , HAS_INTERNET_ACCESS
    , ES_FINANCIABLE
  ) AS ITEMS_MENSUAL -- PARTITION SEGUN GROUP BY DE LO QUE QUIERAS TRAERT

  , MAX(TIM_DAY) OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH) AS MAX_DATE_IN_THE_MONTH

  , (COUNT(ITE_ITEM_ID) OVER 
  (PARTITION BY 
      YEAR_MONTH
    , SIT_SITE_ID
    , USER_TYPE
    , CUS_CUST_ID
    , NOMBREDELCUS
    , ITE_ITEM_ID
    , ITE_ITEM_TITLE
    , SUB_VERTICAL
    , TIER
    , ESTADO
    , CIUDAD
    -- , DIRECCION COMENTADO PORQUE ESTA FLAGEADO POR PII
    , BARRIO_COMUNA
    , LATITUD
    , LONGITUD
    , VIDEO
    , CATEGORIA_L1
    , CATEGORIA_L2
    , CATEGORIA_L3
    , CATEGORIA_L4
    , CATEGORIA_L5
    , CATEGORIA_L6
    , CATEGORIA_L7
    , COMBO
    , ITEM_PADRE
    , ITE_ITEM_DOM_DOMAIN_ID
    , CONDICION
    , ITE_LISTING_TYPE_DESC
    , OPERATION
    , MEASURE_TYPE_TOTAL_AREA
    , TOTAL_AREA
    , MEASURE_TYPE_COVERED_AREA
    , COVERED_AREA
    , MEASURE_TYPE_BALCONY_AREA
    , BALCONY_AREA
    , PROPERTY_AGE
    , PROPERTY_TYPE
    , BEDROOMS
    , FULL_BATHROOMS
    , ROOMS
    , SIT_CURRENCY_MAINTENANCE_FEE
    , MAINTENANCE_FEE
    , APARTMENT_PROPERTY_SUBTYPE
    , PARKING_LOTS
    , SIT_CURRENCY_RESERVATION_FEE
    , RESERVATION_FEE
    , DEVELOPMENT_NAME
    , DEVELOPMENT_STATUS
    , POSSESSION_STATUS
    , CMG_SITE
    , PROPERTY_CODE
    , CONSTRUCTS
    , POSSESSION_DATE
    , DOWN_PAYMENT
    , FURNISHED
    , HAS_BUSINESS_CENTER
    , HAS_GYM
    , HAS_LAUNDRY
    , HAS_COMMON_LAUNDRY
    , HAS_HEATING
    , HAS_MULTIPURPOSE_ROOM
    , HAS_TENNIS_COURT
    , HAS_AIR_CONDITIONING
    , HAS_FRONT_DESK
    , HAS_GUEST_PARKING
    , HAS_JACUZZI
    , HAS_PLAYGROUND
    , HAS_INDOOR_FIREPLACE
    , HAS_PARTY_ROOM
    , HAS_SECURITY
    , HAS_SWIMMING_POOL
    , HAS_BARBECUE_AREA
    , HAS_GRILL
    , WITH_VIRTUAL_TOUR
    , HAS_BALCONY
    , HAS_GARDEN
    , HAS_TERRACE
    , IS_SUITABLE_FOR_PETS
    , PETS_ALLOWED
    , HAS_INTERNET_ACCESS
    , ES_FINANCIABLE
  ) -- NUMERADOR: PARTITION SEGUN GROUP BY DE LO QUE QUIERAS TRAERTE EN ESTE SELECT
  / EXTRACT(DAY FROM MAX(TIM_DAY) OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH))) AS LIVE_LISTINGS -- DENOMINADOR: CANTIDAD DE DÍAS EN EL MES

FROM LL_1

WHERE SIT_SITE_ID IS NOT NULL

QUALIFY ROW_NUMBER () OVER (PARTITION BY SIT_SITE_ID,YEAR_MONTH,ITE_ITEM_ID) = 1 -- EVITAR DUPLICIDAD GENERADA POR SITE_CURRENCY_ID, SITE_CURRENCY_ITEM_PRICE. PK: Una fila por cada MES, SITE, ITEM
;
