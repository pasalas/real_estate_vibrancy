-- PARAMETRO DE PERÍODO MENSUAL
DECLARE FILTRO_PERIODO DATE DEFAULT /*'YYYY-MM-01'*/ '2022-12-01' --<FILTRO_PERIODO>
;

-- PARAMETRO DE SITES A INSERTAR
DECLARE VAR_SITES ARRAY <STRING>;
SET VAR_SITES = ['MCO','MLA','MLB','MLC','MLM','MLU','MLV']
;

-- -- BORRO REGISTROS PARA EVITAR DUPLICIDAD AL INSERTAR MISMO PERIODO VARIAS VECES
-- DELETE `meli-bi-data.SBOX_MKTVIS.DASH_REAL_ESTATE_LEADS_VISITS_MONTHLY`
-- WHERE YEAR_MONTH = FILTRO_PERIODO
-- ;


-- INSERT INTO `meli-bi-data.SBOX_MKTVIS.DASH_REAL_ESTATE_LEADS_VISITS_MONTHLY`

WITH ATRIBUTOS AS
(
  SELECT
      SIT_SITE_ID
    , USER_TYPE
    , CUS_CUST_ID
    , NOMBREDELCUS
    , ITE_ITEM_ID
    , ITE_ITEM_TITLE
    , TIER
    , ESTADO
    , CIUDAD
    -- , DIRECCION COMENTADO PORQUE ESTA FLAGEADO POR PII
    , BARRIO_COMUNA
    , LATITUD
    , LONGITUD
    , VIDEO
    , CATEGORIA_L1
    , CATEGORIA_L2
    , CATEGORIA_L3
    , CATEGORIA_L4
    , CATEGORIA_L5
    , CATEGORIA_L6
    , CATEGORIA_L7
    , COMBO
    , ITEM_PADRE
    , ITE_ITEM_DOM_DOMAIN_ID
    , CONDICION
    , ITE_LISTING_TYPE_DESC
    , OPERATION

    -- TOTAL AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(TOTAL_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_TOTAL_AREA
    , (CASE WHEN REGEXP_EXTRACT(TOTAL_AREA,'[0-9]+') = '0' THEN NULL -- si es 0 ponelo null para que no afecte a promedios tirandolo para abajo
            ELSE REGEXP_EXTRACT(LEFT(TOTAL_AREA,10),'[0-9]+') END) AS TOTAL_AREA -- si no el valor original

    -- COVERED AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(COVERED_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_COVERED_AREA
    , (CASE WHEN REGEXP_EXTRACT(COVERED_AREA,'[0-9]+') = '0' THEN NULL -- si es 0 ponelo null para que no afecte a promedios tirandolo para abajo
            ELSE REGEXP_EXTRACT(LEFT(COVERED_AREA,10),'[0-9]+') END) AS COVERED_AREA -- si no el valor original

    -- BALCONY AREA
    , (CASE WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'CM') IS TRUE THEN 'CM'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'M') IS TRUE THEN 'M'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'H') IS TRUE THEN 'HA'
            WHEN REGEXP_CONTAINS(UPPER(BALCONY_AREA),'I') IS TRUE THEN 'IN'
            END) AS MEASURE_TYPE_BALCONY_AREA
    , REGEXP_EXTRACT(LEFT(BALCONY_AREA,10),'[0-9]+') AS BALCONY_AREA -- 10 m²


    , REGEXP_EXTRACT(LEFT(PROPERTY_AGE,10),'[0-9]+') AS PROPERTY_AGE -- SIEMPRE ES AÑOS

    , PROPERTY_TYPE

    , REGEXP_EXTRACT(LEFT(BEDROOMS,10),'[0-9]+') AS BEDROOMS
    , REGEXP_EXTRACT(LEFT(FULL_BATHROOMS,10),'[0-9]+') AS FULL_BATHROOMS 
    , REGEXP_EXTRACT(LEFT(ROOMS,10),'[0-9]+') AS ROOMS

    , REGEXP_EXTRACT(UPPER(MAINTENANCE_FEE),'[A-Z]+') AS SIT_CURRENCY_MAINTENANCE_FEE
    , CAST(LEFT(REGEXP_EXTRACT(MAINTENANCE_FEE,'[0-9]+'),10) AS NUMERIC) AS MAINTENANCE_FEE


    , CMG_SITE

    , APARTMENT_PROPERTY_SUBTYPE

    , CAST(LEFT(PARKING_LOTS,10) AS NUMERIC) AS PARKING_LOTS

    -- ATRIBUTOS BOOLEANOS: Sí/No
    , FURNISHED
    , HAS_BUSINESS_CENTER
    , HAS_GYM
    , HAS_LAUNDRY
    , HAS_COMMON_LAUNDRY
    , HAS_HEATING
    , HAS_MULTIPURPOSE_ROOM
    , HAS_TENNIS_COURT
    , HAS_AIR_CONDITIONING
    , HAS_FRONT_DESK
    , HAS_GUEST_PARKING
    , HAS_JACUZZI
    , HAS_PLAYGROUND
    , HAS_INDOOR_FIREPLACE
    , HAS_PARTY_ROOM
    , HAS_SECURITY
    , HAS_SWIMMING_POOL
    , HAS_BARBECUE_AREA
    , HAS_GRILL
    , WITH_VIRTUAL_TOUR
    , HAS_BALCONY
    , HAS_GARDEN
    , HAS_TERRACE
    , IS_SUITABLE_FOR_PETS
    , PETS_ALLOWED
    , HAS_INTERNET_ACCESS
    , ES_FINANCIABLE

  FROM `meli-bi-data.SBOX_CLASSI_PLANNING.LK_ATRIBUTOS_IMRE` AS A
)

-- , LEADS AS

SELECT
    DATE_TRUNC(A.FECHA,MONTH) AS YEAR_MONTH
  , A.SIT_SITE_ID AS SITE_ID
  , A.USER_TYPE
  , CAST(A.CUS_CUST_ID AS STRING) AS CUSTOMER_SELLER_ID
  , NOMBREDELCUS AS CUSTOMER_SELLER_NAME	
  , CAST(A.ITE_ITEM_ID AS STRING) AS ITEM_ID
  , ITE_ITEM_TITLE AS ITEM_TITLE_NAME
  , TIER
  , ESTADO AS ITEM_STATE 
  , CIUDAD AS ITEM_CITY
  -- , DIRECCION AS ITEM_ADDRESS COMENTADO PORQUE ESTA FLAGEADO POR PII
  , BARRIO_COMUNA AS ITEM_NEIGHBORHOOD
  , CAST(LATITUD AS STRING) AS ITEM_LATITUD
  , CAST(LONGITUD AS STRING) AS ITEM_LONGITUD
  , VIDEO AS HAS_VIDEO
  , CATEGORIA_L1 AS CATEGORY_NAME_L1
  , CATEGORIA_L2 AS CATEGORY_NAME_L2
  , CATEGORIA_L3 AS CATEGORY_NAME_L3
  , CATEGORIA_L4 AS CATEGORY_NAME_L4
  , CATEGORIA_L5 AS CATEGORY_NAME_L5
  , CATEGORIA_L6 AS CATEGORY_NAME_L6
  , CATEGORIA_L7 AS CATEGORY_NAME_L7

  , A.COMBO
  , CAST(ITEM_PADRE AS STRING) AS ITEM_PARENT_ID
  , ITE_ITEM_DOM_DOMAIN_ID AS ITEM_DOMAIN
  , CONDICION AS ITEM_CONDITION
  , ITE_LISTING_TYPE_DESC AS ITEM_LISTING_TYPE
  , OPERATION
  , PROPERTY_TYPE
  , MEASURE_TYPE_TOTAL_AREA
  , CAST(TOTAL_AREA AS NUMERIC) AS TOTAL_AREA
  , MEASURE_TYPE_COVERED_AREA
  , CAST(COVERED_AREA AS NUMERIC) AS COVERED_AREA
  , MEASURE_TYPE_BALCONY_AREA
  , CAST(BALCONY_AREA AS NUMERIC) AS BALCONY_AREA
  , CAST(PROPERTY_AGE AS NUMERIC) AS PROPERTY_AGE
  , CAST(BEDROOMS AS NUMERIC) AS BEDROOMS
  , CAST(FULL_BATHROOMS AS NUMERIC) AS FULL_BATHROOMS
  , CAST(ROOMS AS NUMERIC) AS ROOMS
  , SIT_CURRENCY_MAINTENANCE_FEE
  , MAINTENANCE_FEE
  , APARTMENT_PROPERTY_SUBTYPE
  , PARKING_LOTS

  , CMG_SITE

  -- ATRIBUTOS BOOLEANOS: Sí/No
  , FURNISHED
  , HAS_BUSINESS_CENTER
  , HAS_GYM
  , HAS_LAUNDRY
  , HAS_COMMON_LAUNDRY
  , HAS_HEATING
  , HAS_MULTIPURPOSE_ROOM
  , HAS_TENNIS_COURT
  , HAS_AIR_CONDITIONING
  , HAS_FRONT_DESK
  , HAS_GUEST_PARKING
  , HAS_JACUZZI
  , HAS_PLAYGROUND
  , HAS_INDOOR_FIREPLACE
  , HAS_PARTY_ROOM
  , HAS_SECURITY
  , HAS_SWIMMING_POOL
  , HAS_BARBECUE_AREA
  , HAS_GRILL
  , WITH_VIRTUAL_TOUR
  , HAS_BALCONY
  , HAS_GARDEN
  , HAS_TERRACE
  , IS_SUITABLE_FOR_PETS
  , PETS_ALLOWED
  , HAS_INTERNET_ACCESS
  , ES_FINANCIABLE

  , B.SIT_CURRENCY_ID AS SITE_CURRENCY_ID
  , B.ITE_CURRENT_PRICE AS SITE_CURRENCY_ITEM_PRICE
  , B.ITEM_LOCAL_PRICE
  , B.ITEM_USD_PRICE

  -- LEAD_SOURCE IN ('TC','ggggg','PI','TI','ML','NA','null','pi','TX','MT','TM','MS','MCO')
  -- CONTACTOS TOTALES
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN _CALL+WHATSAPP+PREGUNTAS_UNICOS+QUOTATIONS_UNICOS+ENTREGAS+PRESUPUESTOS ELSE 0 END) AS ML_CONTACTOS_TOTALES_UNIQUE
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN _CALL+WHATSAPP+PREGUNTAS_UNICOS+QUOTATIONS_UNICOS+ENTREGAS+PRESUPUESTOS ELSE 0 END) AS NO_ML_CONTACTOS_TOTALES_UNIQUE
  , SUM(_CALL+WHATSAPP+PREGUNTAS_UNICOS+QUOTATIONS_UNICOS+ENTREGAS+PRESUPUESTOS) AS CONTACTOS_TOTALES_UNIQUE

  -- CONTACTOS POR TIPO
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN _CALL ELSE 0 END) AS ML_CALL
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN _CALL ELSE 0 END) AS NO_ML_CALL
  , SUM(_CALL) AS CALL

  , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN WHATSAPP ELSE 0 END) AS ML_WHATSAPP
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN WHATSAPP ELSE 0 END) AS NO_ML_WHATSAPP
  , SUM(WHATSAPP) AS WHATSAPP

  --PREGUNTAS POR TIPO
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN PREGUNTAS_UNICOS ELSE 0 END) AS ML_PREGUNTAS_UNICOS
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN PREGUNTAS_UNICOS ELSE 0 END) AS NO_ML_PREGUNTAS_UNICOS
  , SUM(PREGUNTAS_UNICOS) AS PREGUNTAS_UNICOS

  -- ENTREGAS: MOTORS DEPRECADO
  -- , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN ENTREGAS ELSE 0 END) AS ML_ENTREGAS
  -- , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN ENTREGAS ELSE 0 END) AS NO_ML_ENTREGAS
  -- , SUM(ENTREGAS) AS ENTREGAS

  -- QUOTATIONS: SOLO REAL ESTATE
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN QUOTATIONS_UNICOS ELSE 0 END) AS ML_QUOTATIONS_UNICOS
  , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN QUOTATIONS_UNICOS ELSE 0 END) AS NO_ML_QUOTATIONS_UNICOS
  , SUM(QUOTATIONS_UNICOS) AS QUOTATIONS_UNICOS

  -- -- PRESUPUESTOS: SERVICIOS
  -- , SUM(CASE WHEN UPPER(LEAD_SOURCE) = 'ML' THEN PRESUPUESTOS ELSE 0 END) AS ML_PRESUPUESTOS
  -- , SUM(CASE WHEN UPPER(LEAD_SOURCE) <> 'ML' THEN PRESUPUESTOS ELSE 0 END) AS NO_ML_PRESUPUESTOS
  -- , SUM(PRESUPUESTOS) AS PRESUPUESTOS


  -- VISITAS
  , SUM(VIEW_PHONE) AS VIEW_PHONE
  , SUM(VISITAS_IOS) AS VISITAS_IOS
  , SUM(VISITAS_ANDROID) AS VISITAS_ANDROID
  , SUM(VISITAS_MOBILEWEB) AS VISITAS_MOBILEWEB
  , SUM(VISITAS_STD_DESKTOP) AS VISITAS_STD_DESKTOP
  , SUM(VISITAS_OTROS) AS VISITAS_OTROS
  , SUM(VISITAS_TOTAL) AS VISITAS_TOTAL


FROM `meli-bi-data.SBOX_CLASSI_PLANNING.BT_VIBRANCY_TOTAL_SITES` AS A

-- PARA COLUMNAS DE CURRENCY, PRECIO, PRECIO LC Y PRECIO USD
LEFT JOIN 
      (
      SELECT 
      DATE_TRUNC(I.TIM_DAY,MONTH) AS YEAR_MONTH
      , I.SIT_SITE_ID
      , I.ITE_ITEM_ID
      , I.SIT_CURRENCY_ID
      , I.ITE_CURRENT_PRICE
      , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN ITE_CURRENT_PRICE 
                  WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN SAFE_MULTIPLY(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
                  ELSE NULL END) AS ITEM_LOCAL_PRICE
      , (CASE WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') = 'DOL' THEN ITE_CURRENT_PRICE 
                  WHEN REGEXP_EXTRACT(I.SIT_CURRENCY_ID,'[A-Z]+') <> 'DOL' THEN SAFE_DIVIDE(ITE_CURRENT_PRICE , TC.CCO_TC_VALUE)
                  ELSE NULL END) AS ITEM_USD_PRICE

      FROM `meli-bi-data.WHOWNER.BT_LIVE_LISTINGS_CLASSIFIEDS` AS I

      -- LE AGREGO TASA DE CAMBIO PARA COLUMNAS DE PRECIO_LOCAL PRECIO_USD
      LEFT JOIN `meli-bi-data.WHOWNER.LK_CURRENCY_CONVERTION` AS TC
      ON I.SIT_SITE_ID = TC.SIT_SITE_ID
      AND I.TIM_DAY	= TC.TIM_DAY_TC

      WHERE DATE_TRUNC(I.TIM_DAY,MONTH) = FILTRO_PERIODO

      QUALIFY ROW_NUMBER() OVER (PARTITION BY DATE_TRUNC(I.TIM_DAY,MONTH),I.SIT_SITE_ID,I.ITE_ITEM_ID ORDER BY I.TIM_DAY DESC) = 1

      ) AS B
ON A.SIT_SITE_ID = B.SIT_SITE_ID
AND A.ITE_ITEM_ID = B.ITE_ITEM_ID
AND DATE_TRUNC(A.FECHA,MONTH) = B.YEAR_MONTH

-- JOIN ATRIBUTOS
LEFT JOIN ATRIBUTOS AS ATT
ON ATT.ITE_ITEM_ID = A.ITE_ITEM_ID
AND ATT.SIT_SITE_ID = A.SIT_SITE_ID
AND A.CAT_CATEG_ID_L1 = '1459'

WHERE DATE_TRUNC(A.FECHA,MONTH) = FILTRO_PERIODO
AND A.SIT_SITE_ID IN UNNEST(VAR_SITES)
AND A.CAT_CATEG_ID_L1 = '1459'
AND A.FRAUDE = 'N/A'
AND A.SIT_SITE_ID IS NOT NULL
AND ATT.CATEGORIA_L4 NOT IN ('Desarrollos Inmobiliarios','Emprendimientos','Emprendimientos Inmobiliarios','Lançamentos','Proyectos') -- NO TRAIGO DESARROLLOS

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74
;
